<div class="flex flex-col flex-auto min-w-0">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:px-10 sm:py-2 border-b bg-card dark:bg-transparent min-h-[72.8px]">
        <div class="flex-1 min-w-0">
            <!-- Breadcrumbs -->
            <div class="flex flex-col">
                <div class="hidden sm:flex font-medium">
                    <!-- Título "Editar usuario" -->
                    <div class="mr-8">
                        <a class="whitespace-nowrap text-secondary-500 md:text-2xl">{{ simulation?.name }}</a>
                    </div>
                    <div class="flex items-end pb-1">
                        <a class="whitespace-nowrap text-primary-500">Inicio</a>
                        <mat-icon class="icon-size-5 text-secondary mx-1" [svgIcon]="'heroicons_mini:chevron-right'"></mat-icon>
                        <span class="whitespace-nowrap text-primary-500">Simulaciones</span>
                        <mat-icon class="icon-size-5 text-secondary mx-1" [svgIcon]="'heroicons_mini:chevron-right'"></mat-icon>
                        <span class="text-secondary">{{ simulation?.name }}</span>
                    </div>
                </div>
            </div>                                 
        </div>
    </div>

    <!-- Main -->
    <div class="flex-auto p-6 sm:px-10">
        <div class="flex w-full">
            <!-- Primer formulario que ocupa 2/3 -->
            <div class="max-h-400 rounded-2xl w-2/3">
                <form [formGroup]="simulationForm" (ngSubmit)="onSubmit()" class="flex flex-col p-8 pb-0 bg-card rounded-2xl shadow overflow-hidden">
                    <!-- Contenedor para alinear las dos columnas 50/50 -->
                    <div class="flex gap-4">
                        
                        <!-- Primera columna con "Nombre" y "Localización" -->
                        <div class="w-1/2 flex flex-col mr-2">
                            <!-- Campo Nombre -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Nombre</mat-label>
                                <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                                    <input matInput formControlName="name" class="p-0" [value]="simulation?.name">
                                </mat-form-field>
                            </div>

                            <!-- Campo "Nº elementos a simular" con valores mínimo y máximo -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Nº registros en cada instante</mat-label>
                                <!-- Contenedor de los campos Mínimo y Máximo -->
                                <div class="flex">
                                    <!-- Campo Mínimo -->
                                    <div class="w-2/5 mr-2">
                                        <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                                            <input matInput type="number" formControlName="minRegistrosPorInstante" placeholder="Mínimo" min="0" [value]="simulation?.minRegistrosPorInstante">
                                        </mat-form-field>
                                    </div>
                                    <!-- Campo Máximo -->
                                    <div class="w-3/5">
                                        <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                                            <input matInput type="number" formControlName="maxRegistrosPorInstante" placeholder="Máximo" min="0" [value]="simulation?.maxRegistrosPorInstante">                                      
                                            <!-- Checkbox con mayor ancho -->
                                            <mat-checkbox formControlName="noRepetirCheckbox" class="ml-4 flex-grow" [checked]="simulation?.noRepetirCheckbox">
                                                <div class="text-sm">No repetir elementos</div>
                                            </mat-checkbox>
                                        </mat-form-field>
                                    </div>
                                </div>
                                <div class="">
                                    <!-- Mensaje de error -->
                                    <div *ngIf="simulationForm.hasError('registrosExcedenCoordenadas')" class="text-red-500 text-sm mb-2">
                                        El número de registros por instante no puede ser superior a la cantidad de localizaciones cuando "No repetir elementos" está activo.
                                    </div>
                                </div>
                            </div>
                            <!-- Campo "Nº elementos a simular" -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Total registros a simular <span style="color: lightslategray">(0 significa infinito)</span></mat-label>
                                <mat-form-field [ngClass]="formFieldHelpers" class="w-full flex items-center p-0">
                                    <input matInput type="number" formControlName="numElementosASimular" min="0" required [value]="simulation?.numElementosASimular">
                                </mat-form-field>
                            </div>
                        </div>

                        <!-- Segunda columna con "Segundo Nombre" y "Segunda Lista" -->
                        <div class="w-1/2 flex flex-col">
                            <!-- Segundo campo Nombre -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Sensores</mat-label>
                                <mat-form-field [ngClass]="formFieldHelpers" class="w-full p-0">
                                    <mat-select formControlName="sensorId" [value]="simulation?.sensorId">
                                        <mat-option *ngFor="let sensor of sensors" [value]="sensor.id">
                                            {{ sensor.name }} ({{ sensor.coordinates.length }})
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Segunda lista desplegable -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Tiempo entre registros <span style="color: lightslategray">(seg.)</span></mat-label>
                                <!-- Contenedor de los campos Mínimo y Máximo -->
                                <div class="flex">
                                    <!-- Campo Mínimo -->
                                    <div class="w-1/2 mr-2">
                                        <mat-form-field [ngClass]="formFieldHelpers" class="w-full p-0" >
                                            <input matInput type="number" formControlName="minIntervaloEntreRegistros" placeholder="Mínimo" min="0" [value]="simulation?.minIntervaloEntreRegistros">
                                        </mat-form-field>
                                    </div>
                                    <!-- Campo Máximo -->
                                    <div class="w-1/2">
                                        <mat-form-field [ngClass]="formFieldHelpers" class="w-full p-0">
                                            <input matInput type="number" formControlName="maxIntervaloEntreRegistros" placeholder="Máximo" min="0" [value]="simulation?.maxIntervaloEntreRegistros">
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo "Fecha de inicio" -->
                            <div class="flex flex-col">
                                <mat-label class="block mb-2">Fecha de inicio <span style="color: lightslategray">(DD/MM/YYYY HH:mm:ss)</span> </mat-label>
                              
                                <mat-form-field class="w-full">
                                    <input 
                                        matInput 
                                        type="text" 
                                        formControlName="date" 
                                        [value]="simulation?.date"
                                        [placeholder]="placeholderText">  <!-- Usar la variable para el placeholder -->
                                    <mat-hint>
                                        <button  (click)="setPlaceholderToNow()" class="text-gray-500 underline bg-transparent border-none cursor-pointer"> Usar fecha actual </button>
                                    </mat-hint>
                                </mat-form-field> 
                            </div>                              
                        </div>
                    </div>                  
            
                    <!-- Campo de Parámetros que ocupa todo el ancho -->
                    <div class="flex flex-col mb-4">
                        <mat-label class="block mb-1 flex items-center">Parámetros
                            <div class="flex items-center relative">
                                <!-- Botón de información con ícono -->
                                <button mat-icon-button (click)="showTooltip = !showTooltip" type="button">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                                </button>
                                <!-- Div flotante que muestra el formato JSON -->
                                <div *ngIf="showTooltip"
                                    class="bg-gray-50 absolute left-10 z-50 bg-white border border-gray-300 shadow-lg p-4 min-w-[450px] max-w-[600px] max-h-[480px] overflow-y-auto">
                                    <div class="flex justify-between items-start pb-0">
                                        <h4 class="text-base font-semibold">Formato JSON</h4>
                                        <!-- Botón de cerrar (X) -->
                                        <button mat-icon-button (click)="showTooltip = false" aria-label="Cerrar" type="button">
                                            <mat-icon class="text-gray-500 icon-size-5">close</mat-icon>
                                        </button>
                                    </div>
                                    <!-- Contenido JSON -->
                                    <div [innerHTML]="formattedFormatJson"></div>
            
                                    <!-- Botón para copiar el contenido -->
                                    <button mat-button class="absolute right-4 bottom-4 flex items-center"
                                        (click)="copyToClipboard()" (click)="showTooltip = false">
                                        <mat-icon>content_copy</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </mat-label>
            
                        <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                            <textarea matInput
                                      formControlName="parameters"
                                      (keydown)="onKeydown($event)"
                                      class="h-55"
                                      rows="10"
                                      [placeholder]="placeholderText"
                                      [value]="simulation?.parameters ? (simulation?.parameters | json) : '{}'"></textarea>
                        </mat-form-field>                        
                        
                    </div>   
    
                    <div class="flex items-center justify-between border-t -mx-8 px-8 py-4 bg-gray-50 dark:bg-gray-700 rounded-b-lg">
                        <!-- Botón para generar la simulación al principio -->
                        <div class="flex">
                            <button mat-stroked-button color="accent" (click)="testSimulation()" class="bg-white mr-4" type="button">
                                <span class="material-icons" style="vertical-align: middle; margin-right: 4px;">play_arrow</span>
                                Probar Simulación
                            </button>
                        </div>
                        <!-- Botones "Cancelar" y "Guardar" alineados a la derecha -->
                        <div class="flex items-center">
                            <button mat-button type="button" (click)="volver()" class="ml-3">Volver</button>
                            <button class="px-6 ml-3 text-white" mat-flat-button [color]="'primary'" type="submit">
                                Guardar
                            </button>
                        </div>
                    </div>                                                    
                </form>
            </div>
            <!-- Segundo formulario que ocupa 1/3 -->
            <div class="max-h-400 rounded-2xl w-1/3 ml-4">
                <div class="flex flex-col p-6 bg-card rounded-2xl shadow overflow-hidden h-[calc(102vh-190px)]"> <!-- Ajuste de alto fijo con h-96 -->
                    <mat-label class="block mb-4 text-lg">Simulación generada</mat-label>
                    <div class="flex flex-col p-4 bg-card rounded-2xl shadow overflow-auto bg-gray-50 h-full"> <!-- Se añadió overflow-auto -->
                        <div *ngIf="generatedSimulation; else noSimulation">
                            <div [innerHTML]="formattedSimulationJson" class="text-base"></div>
                        </div>
                        <ng-template #noSimulation>
                            <!-- Muestra un mensaje o JSON vacío si no hay simulación generada -->
                            <pre>{{ '{ ' }}{{ '}' }}</pre>
                        </ng-template>
                    </div>
                    <div *ngIf="showAlert" class="flex items-center p-4 mt-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
                        <div> Genera simulación antes de crear. </div>
                    </div>  
                </div>                               
            </div>                  
        </div>                             
    </div>
</div>  
